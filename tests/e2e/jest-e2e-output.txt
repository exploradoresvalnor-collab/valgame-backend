
> valgame-backend@1.0.0 test:e2e
> npx jest --runInBand --detectOpenHandles

  console.log
    [API] Modo test: no se inicia conexi√≥n autom√°tica a MongoDB ni servidor HTTP.

      at Object.<anonymous> (src/app.ts:169:11)

  console.log
    [DB] Conectado a MongoDB

      at connectDB (src/config/db.ts:12:11)

  console.log
    [MAILER] Usando cuenta de prueba de Ethereal (no necesitas credenciales).

      at createTransporter (src/config/mailer.ts:23:13)

  console.log
    [MAILER] Correo de prueba enviado. Vista previa disponible en: https://ethereal.email/message/aPZnIow8PbMuALImaPZnJIQ.v3CUwlaPAAAAAcWSHXsmvYEO7ItytcRyklA

      at sendVerificationEmail (src/config/mailer.ts:84:13)

  console.error
    Error al listar item: MongoServerError: Transaction numbers are only allowed on a replica set member or mongos
        at Connection.sendCommand (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\cmap\connection.ts:559:17)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Connection.command (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\cmap\connection.ts:633:22)
        at Server.command (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\sdam\server.ts:350:21)
        at tryOperation (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\operations\execute_operation.ts:289:24)
        at executeOperation (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\operations\execute_operation.ts:119:12)
        at Collection.insertOne (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\collection.ts:294:12) {
      errorLabelSet: Set(0) {},
      errorResponse: {
        ok: 0,
        errmsg: 'Transaction numbers are only allowed on a replica set member or mongos',
        code: 20,
        codeName: 'IllegalOperation'
      },
      ok: 0,
      code: 20,
      codeName: 'IllegalOperation'
    }

    [0m [90m 143 |[39m     [36mreturn[39m createdListing[33m;[39m
     [90m 144 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 145 |[39m     console[33m.[39merror([32m'Error al listar item:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 146 |[39m     [36mthrow[39m error[33m;[39m
     [90m 147 |[39m   } [36mfinally[39m {
     [90m 148 |[39m     session[33m.[39mendSession()[33m;[39m[0m

      at Object.listItem (src/services/marketplace.service.ts:145:13)
      at src/routes/marketplace.routes.ts:51:21

  console.error
    
    ==================== UNHANDLED ERROR ====================

    [0m [90m  6 |[39m
     [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
    [31m[1m>[22m[39m[90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:8:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:63:7

  console.error
    [2025-10-20T16:45:23.662Z] POST /api/marketplace/listings

    [0m [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
     [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
    [31m[1m>[22m[39m[90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   [0m

      at errorHandler (src/middlewares/errorHandler.ts:9:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:63:7

  console.error
    Error Message: Transaction numbers are only allowed on a replica set member or mongos

    [0m [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:10:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:63:7

  console.error
    Error Status: 500

    [0m [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
    [31m[1m>[22m[39m[90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {[0m

      at errorHandler (src/middlewares/errorHandler.ts:11:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:63:7

  console.error
    Stack Trace:

    [0m [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
    [31m[1m>[22m[39m[90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:15:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:63:7

  console.error
    MongoServerError: Transaction numbers are only allowed on a replica set member or mongos
        at Connection.sendCommand (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\cmap\connection.ts:559:17)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Connection.command (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\cmap\connection.ts:633:22)
        at Server.command (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\sdam\server.ts:350:21)
        at tryOperation (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\operations\execute_operation.ts:289:24)
        at executeOperation (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\operations\execute_operation.ts:119:12)
        at Collection.insertOne (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\collection.ts:294:12)

    [0m [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
     [90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m
     [90m 19 |[39m   }[0m

      at errorHandler (src/middlewares/errorHandler.ts:16:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:63:7

  console.error
    =========================================================

    [0m [90m 19 |[39m   }
     [90m 20 |[39m   
    [31m[1m>[22m[39m[90m 21 |[39m   console[33m.[39merror([32m'=========================================================\n'[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 22 |[39m
     [90m 23 |[39m   [90m// No enviar el stack trace en producci√≥n[39m
     [90m 24 |[39m   [36mconst[39m errorResponse [33m=[39m {[0m

      at errorHandler (src/middlewares/errorHandler.ts:21:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:63:7

  console.error
    Error al comprar item: CastError: Cast to ObjectId failed for value "undefined" (type string) at path "_id" for model "Listing"
        at SchemaObjectId.Object.<anonymous>.SchemaObjectId.cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schema\objectId.js:251:11)
        at SchemaObjectId.Object.<anonymous>.SchemaType.applySetters (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schemaType.js:1259:12)
        at SchemaObjectId.Object.<anonymous>.SchemaType.castForQuery (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schemaType.js:1695:17)
        at cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\cast.js:390:32)
        at model.Query.Object.<anonymous>.Query.cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:5060:12)
        at model.Query.Object.<anonymous>.Query._castConditions (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:2374:10)
        at model.Query._findOneAndUpdate (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:3477:8)
        at model.Query.exec (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:4627:80)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at C:\Users\Haustman\Desktop\valgame-backend\src\services\marketplace.service.ts:252:24
        at ClientSession.withTransaction (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\sessions.ts:750:20)
        at Object.buyItem (C:\Users\Haustman\Desktop\valgame-backend\src\services\marketplace.service.ts:249:19)
        at C:\Users\Haustman\Desktop\valgame-backend\src\routes\marketplace.routes.ts:87:20 {
      stringValue: '"undefined"',
      messageFormat: undefined,
      kind: 'ObjectId',
      value: 'undefined',
      path: '_id',
      reason: BSONError: input must be a 24 character hex string, 12 byte Uint8Array, or an integer
          at new ObjectId (C:\Users\Haustman\Desktop\valgame-backend\node_modules\bson\src\objectid.ts:120:15)
          at castObjectId (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\cast\objectid.js:25:12)
          at SchemaObjectId.Object.<anonymous>.SchemaObjectId.cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schema\objectId.js:249:12)
          at SchemaObjectId.Object.<anonymous>.SchemaType.applySetters (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schemaType.js:1259:12)
          at SchemaObjectId.Object.<anonymous>.SchemaType.castForQuery (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schemaType.js:1695:17)
          at cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\cast.js:390:32)
          at model.Query.Object.<anonymous>.Query.cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:5060:12)
          at model.Query.Object.<anonymous>.Query._castConditions (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:2374:10)
          at model.Query._findOneAndUpdate (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:3477:8)
          at model.Query.exec (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:4627:80)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at C:\Users\Haustman\Desktop\valgame-backend\src\services\marketplace.service.ts:252:24
          at ClientSession.withTransaction (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\sessions.ts:750:20)
          at Object.buyItem (C:\Users\Haustman\Desktop\valgame-backend\src\services\marketplace.service.ts:249:19)
          at C:\Users\Haustman\Desktop\valgame-backend\src\routes\marketplace.routes.ts:87:20,
      valueType: 'string'
    }

    [0m [90m 356 |[39m     [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m transaction[33m:[39m listing }[33m;[39m
     [90m 357 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 358 |[39m     console[33m.[39merror([32m'Error al comprar item:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 359 |[39m     [36mthrow[39m error[33m;[39m
     [90m 360 |[39m   } [36mfinally[39m {
     [90m 361 |[39m     session[33m.[39mendSession()[33m;[39m[0m

      at Object.buyItem (src/services/marketplace.service.ts:358:13)
      at src/routes/marketplace.routes.ts:87:20

  console.error
    
    ==================== UNHANDLED ERROR ====================

    [0m [90m  6 |[39m
     [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
    [31m[1m>[22m[39m[90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:8:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:90:5

  console.error
    [2025-10-20T16:45:23.944Z] POST /api/marketplace/listings/undefined/buy

    [0m [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
     [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
    [31m[1m>[22m[39m[90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   [0m

      at errorHandler (src/middlewares/errorHandler.ts:9:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:90:5

  console.error
    Error Message: Cast to ObjectId failed for value "undefined" (type string) at path "_id" for model "Listing"

    [0m [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:10:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:90:5

  console.error
    Error Status: 500

    [0m [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
    [31m[1m>[22m[39m[90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {[0m

      at errorHandler (src/middlewares/errorHandler.ts:11:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:90:5

  console.error
    Stack Trace:

    [0m [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
    [31m[1m>[22m[39m[90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:15:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:90:5

  console.error
    CastError: Cast to ObjectId failed for value "undefined" (type string) at path "_id" for model "Listing"
        at SchemaObjectId.Object.<anonymous>.SchemaObjectId.cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schema\objectId.js:251:11)
        at SchemaObjectId.Object.<anonymous>.SchemaType.applySetters (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schemaType.js:1259:12)
        at SchemaObjectId.Object.<anonymous>.SchemaType.castForQuery (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\schemaType.js:1695:17)
        at cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\cast.js:390:32)
        at model.Query.Object.<anonymous>.Query.cast (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:5060:12)
        at model.Query.Object.<anonymous>.Query._castConditions (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:2374:10)
        at model.Query._findOneAndUpdate (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:3477:8)
        at model.Query.exec (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongoose\lib\query.js:4627:80)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at C:\Users\Haustman\Desktop\valgame-backend\src\services\marketplace.service.ts:252:24
        at ClientSession.withTransaction (C:\Users\Haustman\Desktop\valgame-backend\node_modules\mongodb\src\sessions.ts:750:20)
        at Object.buyItem (C:\Users\Haustman\Desktop\valgame-backend\src\services\marketplace.service.ts:249:19)
        at C:\Users\Haustman\Desktop\valgame-backend\src\routes\marketplace.routes.ts:87:20

    [0m [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
     [90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m
     [90m 19 |[39m   }[0m

      at errorHandler (src/middlewares/errorHandler.ts:16:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:90:5

  console.error
    =========================================================

    [0m [90m 19 |[39m   }
     [90m 20 |[39m   
    [31m[1m>[22m[39m[90m 21 |[39m   console[33m.[39merror([32m'=========================================================\n'[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 22 |[39m
     [90m 23 |[39m   [90m// No enviar el stack trace en producci√≥n[39m
     [90m 24 |[39m   [36mconst[39m errorResponse [33m=[39m {[0m

      at errorHandler (src/middlewares/errorHandler.ts:21:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at src/routes/marketplace.routes.ts:90:5

  console.error
    
    ==================== UNHANDLED ERROR ====================

    [0m [90m  6 |[39m
     [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
    [31m[1m>[22m[39m[90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:8:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [2025-10-20T16:45:24.414Z] POST /auth/login

    [0m [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
     [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
    [31m[1m>[22m[39m[90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   [0m

      at errorHandler (src/middlewares/errorHandler.ts:9:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error Message: Demasiadas peticiones

    [0m [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:10:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error Status: 429

    [0m [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
    [31m[1m>[22m[39m[90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {[0m

      at errorHandler (src/middlewares/errorHandler.ts:11:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Stack Trace:

    [0m [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
    [31m[1m>[22m[39m[90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:15:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error: Demasiadas peticiones
        at Object.handleRateLimit [as handler] (C:\Users\Haustman\Desktop\valgame-backend\src\middlewares\rateLimits.ts:71:8)
        at C:\Users\Haustman\Desktop\valgame-backend\node_modules\express-rate-limit\dist\index.cjs:804:16
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at C:\Users\Haustman\Desktop\valgame-backend\node_modules\express-rate-limit\dist\index.cjs:691:5

    [0m [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
     [90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m
     [90m 19 |[39m   }[0m

      at errorHandler (src/middlewares/errorHandler.ts:16:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    =========================================================

    [0m [90m 19 |[39m   }
     [90m 20 |[39m   
    [31m[1m>[22m[39m[90m 21 |[39m   console[33m.[39merror([32m'=========================================================\n'[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 22 |[39m
     [90m 23 |[39m   [90m// No enviar el stack trace en producci√≥n[39m
     [90m 24 |[39m   [36mconst[39m errorResponse [33m=[39m {[0m

      at errorHandler (src/middlewares/errorHandler.ts:21:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    
    ==================== UNHANDLED ERROR ====================

    [0m [90m  6 |[39m
     [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
    [31m[1m>[22m[39m[90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:8:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [2025-10-20T16:45:24.487Z] POST /auth/login

    [0m [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
     [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
    [31m[1m>[22m[39m[90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   [0m

      at errorHandler (src/middlewares/errorHandler.ts:9:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error Message: Demasiadas peticiones

    [0m [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:10:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error Status: 429

    [0m [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
    [31m[1m>[22m[39m[90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {[0m

      at errorHandler (src/middlewares/errorHandler.ts:11:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Stack Trace:

    [0m [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
    [31m[1m>[22m[39m[90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:15:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error: Demasiadas peticiones
        at Object.handleRateLimit [as handler] (C:\Users\Haustman\Desktop\valgame-backend\src\middlewares\rateLimits.ts:71:8)
        at C:\Users\Haustman\Desktop\valgame-backend\node_modules\express-rate-limit\dist\index.cjs:804:16
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at C:\Users\Haustman\Desktop\valgame-backend\node_modules\express-rate-limit\dist\index.cjs:691:5

    [0m [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
     [90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m
     [90m 19 |[39m   }[0m

      at errorHandler (src/middlewares/errorHandler.ts:16:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    =========================================================

    [0m [90m 19 |[39m   }
     [90m 20 |[39m   
    [31m[1m>[22m[39m[90m 21 |[39m   console[33m.[39merror([32m'=========================================================\n'[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 22 |[39m
     [90m 23 |[39m   [90m// No enviar el stack trace en producci√≥n[39m
     [90m 24 |[39m   [36mconst[39m errorResponse [33m=[39m {[0m

      at errorHandler (src/middlewares/errorHandler.ts:21:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.warn
    [RATE_LIMIT_ALERT] IP ::ffff:127.0.0.1 ha excedido l√≠mites 3 veces en la √∫ltima hora

    [0m [90m 49 |[39m     [36mif[39m (record[33m.[39mattempts [33m>=[39m [33mALERT_THRESHOLD[39m) {
     [90m 50 |[39m       record[33m.[39mwarnings[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 51 |[39m       console[33m.[39mwarn([32m`[RATE_LIMIT_ALERT] IP ${ip} ha excedido l√≠mites ${record.attempts} veces en la √∫ltima hora`[39m)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 52 |[39m       
     [90m 53 |[39m       [90m// Aqu√≠ podr√≠as integrar con un sistema de monitoreo externo[39m
     [90m 54 |[39m       [36mif[39m (process[33m.[39menv[33m.[39m[33mMONITORING_WEBHOOK[39m) {[0m

      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:51:15)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    
    ==================== UNHANDLED ERROR ====================

    [0m [90m  6 |[39m
     [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
    [31m[1m>[22m[39m[90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:8:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [2025-10-20T16:45:24.582Z] POST /auth/login

    [0m [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
     [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
    [31m[1m>[22m[39m[90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   [0m

      at errorHandler (src/middlewares/errorHandler.ts:9:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error Message: Demasiadas peticiones

    [0m [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:10:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error Status: 429

    [0m [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
    [31m[1m>[22m[39m[90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {[0m

      at errorHandler (src/middlewares/errorHandler.ts:11:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Stack Trace:

    [0m [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
    [31m[1m>[22m[39m[90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:15:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error: Demasiadas peticiones
        at Object.handleRateLimit [as handler] (C:\Users\Haustman\Desktop\valgame-backend\src\middlewares\rateLimits.ts:71:8)
        at C:\Users\Haustman\Desktop\valgame-backend\node_modules\express-rate-limit\dist\index.cjs:804:16
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at C:\Users\Haustman\Desktop\valgame-backend\node_modules\express-rate-limit\dist\index.cjs:691:5

    [0m [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
     [90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m
     [90m 19 |[39m   }[0m

      at errorHandler (src/middlewares/errorHandler.ts:16:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    =========================================================

    [0m [90m 19 |[39m   }
     [90m 20 |[39m   
    [31m[1m>[22m[39m[90m 21 |[39m   console[33m.[39merror([32m'=========================================================\n'[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 22 |[39m
     [90m 23 |[39m   [90m// No enviar el stack trace en producci√≥n[39m
     [90m 24 |[39m   [36mconst[39m errorResponse [33m=[39m {[0m

      at errorHandler (src/middlewares/errorHandler.ts:21:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.warn
    [RATE_LIMIT_ALERT] IP ::ffff:127.0.0.1 ha excedido l√≠mites 4 veces en la √∫ltima hora

    [0m [90m 49 |[39m     [36mif[39m (record[33m.[39mattempts [33m>=[39m [33mALERT_THRESHOLD[39m) {
     [90m 50 |[39m       record[33m.[39mwarnings[33m++[39m[33m;[39m
    [31m[1m>[22m[39m[90m 51 |[39m       console[33m.[39mwarn([32m`[RATE_LIMIT_ALERT] IP ${ip} ha excedido l√≠mites ${record.attempts} veces en la √∫ltima hora`[39m)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 52 |[39m       
     [90m 53 |[39m       [90m// Aqu√≠ podr√≠as integrar con un sistema de monitoreo externo[39m
     [90m 54 |[39m       [36mif[39m (process[33m.[39menv[33m.[39m[33mMONITORING_WEBHOOK[39m) {[0m

      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:51:15)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    
    ==================== UNHANDLED ERROR ====================

    [0m [90m  6 |[39m
     [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
    [31m[1m>[22m[39m[90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:8:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [2025-10-20T16:45:24.673Z] POST /auth/login

    [0m [90m  7 |[39m   [90m// Log detallado para depuraci√≥n[39m
     [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
    [31m[1m>[22m[39m[90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   [0m

      at errorHandler (src/middlewares/errorHandler.ts:9:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error Message: Demasiadas peticiones

    [0m [90m  8 |[39m   console[33m.[39merror([32m'\n==================== UNHANDLED ERROR ===================='[39m)[33m;[39m
     [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:10:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error Status: 429

    [0m [90m  9 |[39m   console[33m.[39merror([32m`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`[39m)[33m;[39m
     [90m 10 |[39m   console[33m.[39merror([32m'Error Message:'[39m[33m,[39m message)[33m;[39m
    [31m[1m>[22m[39m[90m 11 |[39m   console[33m.[39merror([32m'Error Status:'[39m[33m,[39m status)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 12 |[39m   
     [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {[0m

      at errorHandler (src/middlewares/errorHandler.ts:11:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Stack Trace:

    [0m [90m 13 |[39m   [90m// Imprimir el stack trace si est√° disponible[39m
     [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
    [31m[1m>[22m[39m[90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m[0m

      at errorHandler (src/middlewares/errorHandler.ts:15:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    Error: Demasiadas peticiones
        at Object.handleRateLimit [as handler] (C:\Users\Haustman\Desktop\valgame-backend\src\middlewares\rateLimits.ts:71:8)
        at C:\Users\Haustman\Desktop\valgame-backend\node_modules\express-rate-limit\dist\index.cjs:804:16
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at C:\Users\Haustman\Desktop\valgame-backend\node_modules\express-rate-limit\dist\index.cjs:691:5

    [0m [90m 14 |[39m   [36mif[39m (err[33m.[39mstack) {
     [90m 15 |[39m     console[33m.[39merror([32m'Stack Trace:'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 16 |[39m     console[33m.[39merror(err[33m.[39mstack)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 17 |[39m   } [36melse[39m {
     [90m 18 |[39m     console[33m.[39merror([32m'Full Error Object:'[39m[33m,[39m err)[33m;[39m
     [90m 19 |[39m   }[0m

      at errorHandler (src/middlewares/errorHandler.ts:16:13)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    =========================================================

    [0m [90m 19 |[39m   }
     [90m 20 |[39m   
    [31m[1m>[22m[39m[90m 21 |[39m   console[33m.[39merror([32m'=========================================================\n'[39m)[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 22 |[39m
     [90m 23 |[39m   [90m// No enviar el stack trace en producci√≥n[39m
     [90m 24 |[39m   [36mconst[39m errorResponse [33m=[39m {[0m

      at errorHandler (src/middlewares/errorHandler.ts:21:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Object.handleRateLimit [as handler] (src/middlewares/rateLimits.ts:71:3)
      at node_modules/express-rate-limit/dist/index.cjs:804:16
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.log
    [DB] Desconectado de MongoDB

      at disconnectDB (src/config/db.ts:21:11)

FAIL tests/e2e/full-system.e2e.test.ts (13.532 s)
  Sistema Completo E2E
    1. Sistema de Onboarding y Autenticaci√≥n
      ‚àö deber√≠a registrar un nuevo usuario (3410 ms)
      ‚àö deber√≠a verificar la cuenta, recibir el paquete, iniciar sesi√≥n y obtener un token (215 ms)
      ‚àö deber√≠a obtener el inventario y personaje iniciales correctamente (56 ms)
    2. Sistema de Marketplace
      √ó deber√≠a crear un listing (124 ms)
      √ó deber√≠a buscar listings (94 ms)
      √ó deber√≠a fallar al intentar comprar su propio item (175 ms)
      √ó deber√≠a cancelar el listing para recuperar el item (64 ms)
    3. Sistema de Items
      √ó deber√≠a usar un consumible (128 ms)
    4. Mec√°nicas de Supervivencia
      ‚àö deber√≠a curar un personaje (80 ms)
      ‚àö deber√≠a revivir un personaje (101 ms)
    5. Rate Limiting
      ‚àö deber√≠a bloquear despu√©s de muchos intentos de login fallidos (393 ms)
    6. Sistema de Evoluci√≥n
      ‚àö deber√≠a evolucionar un personaje (197 ms)

  ‚óè Sistema Completo E2E ‚Ä∫ 2. Sistema de Marketplace ‚Ä∫ deber√≠a crear un listing

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 80 |[39m         [33m.[39msend({ itemId[33m:[39m itemId[33m,[39m precio[33m:[39m [35m100[39m[33m,[39m cantidad[33m:[39m [35m1[39m })[33m;[39m
     [90m 81 |[39m
    [31m[1m>[22m[39m[90m 82 |[39m       expect(res[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                          [31m[1m^[22m[39m
     [90m 83 |[39m       listingId [33m=[39m res[33m.[39mbody[33m.[39mlisting[33m.[39mid[33m;[39m
     [90m 84 |[39m
     [90m 85 |[39m       [90m// Validaci√≥n: El item ya no debe estar en el inventario del usuario[39m[0m

      at Object.<anonymous> (tests/e2e/full-system.e2e.test.ts:82:26)

  ‚óè Sistema Completo E2E ‚Ä∫ 2. Sistema de Marketplace ‚Ä∫ deber√≠a buscar listings

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

    [0m [90m  97 |[39m       expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m  98 |[39m       expect([33mArray[39m[33m.[39misArray(res[33m.[39mbody[33m.[39mlistings))[33m.[39mtoBe([36mtrue[39m)[33m;[39m
    [31m[1m>[22m[39m[90m  99 |[39m       expect(res[33m.[39mbody[33m.[39mlistings[33m.[39mlength)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m
     [90m     |[39m                                        [31m[1m^[22m[39m
     [90m 100 |[39m     })[33m;[39m
     [90m 101 |[39m
     [90m 102 |[39m     it([32m'deber√≠a fallar al intentar comprar su propio item'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (tests/e2e/full-system.e2e.test.ts:99:40)

  ‚óè Sistema Completo E2E ‚Ä∫ 2. Sistema de Marketplace ‚Ä∫ deber√≠a fallar al intentar comprar su propio item

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

    [0m [90m 105 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 106 |[39m
    [31m[1m>[22m[39m[90m 107 |[39m       expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 108 |[39m     })[33m;[39m
     [90m 109 |[39m
     [90m 110 |[39m     it([32m'deber√≠a cancelar el listing para recuperar el item'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (tests/e2e/full-system.e2e.test.ts:107:26)

  ‚óè Sistema Completo E2E ‚Ä∫ 2. Sistema de Marketplace ‚Ä∫ deber√≠a cancelar el listing para recuperar el item

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 113 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${authToken}`[39m)[33m;[39m
     [90m 114 |[39m
    [31m[1m>[22m[39m[90m 115 |[39m       expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 116 |[39m       expect(res[33m.[39mbody[33m.[39mmessage)[33m.[39mtoMatch([35m/Listado cancelado exitosamente/[39m)[33m;[39m
     [90m 117 |[39m
     [90m 118 |[39m       [90m// Validaci√≥n: El item debe haber vuelto al inventario del usuario[39m[0m

      at Object.<anonymous> (tests/e2e/full-system.e2e.test.ts:115:26)

  ‚óè Sistema Completo E2E ‚Ä∫ 3. Sistema de Items ‚Ä∫ deber√≠a usar un consumible

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

    [0m [90m 142 |[39m       [36mconst[39m charPost [33m=[39m userPost[33m![39m[33m.[39mpersonajes[33m.[39mfind(p [33m=>[39m p[33m.[39mpersonajeId [33m===[39m characterId)[33m![39m[33m;[39m
     [90m 143 |[39m       expect(charPost[33m.[39msaludActual)[33m.[39mtoBe([35m100[39m)[33m;[39m [90m// 50 (da√±o) + 50 (poci√≥n)[39m
    [31m[1m>[22m[39m[90m 144 |[39m       expect(userPost[33m![39m[33m.[39minventarioConsumibles[33m.[39msome(c [33m=>[39m c[33m.[39mconsumableId[33m.[39mtoString() [33m===[39m itemId))[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m     |[39m                                                                                               [31m[1m^[22m[39m
     [90m 145 |[39m     })[33m;[39m
     [90m 146 |[39m   })[33m;[39m
     [90m 147 |[39m[0m

      at Object.<anonymous> (tests/e2e/full-system.e2e.test.ts:144:95)

  console.log
    [API] Modo test: no se inicia conexi√≥n autom√°tica a MongoDB ni servidor HTTP.

      at Object.<anonymous> (src/app.ts:169:11)

  console.log
    [DB] Conectado a MongoDB

      at connectDB (src/config/db.ts:12:11)

  console.log
    [MAILER] Usando cuenta de prueba de Ethereal (no necesitas credenciales).

      at createTransporter (src/config/mailer.ts:23:13)

  console.log
    [MAILER] Correo de prueba enviado. Vista previa disponible en: https://ethereal.email/message/aPZnKYw8PbMuALKuaPZnK4Q.v3CUwlaVAAAAATSA9zFUa4VKKMbMi7bcvt0

      at sendVerificationEmail (src/config/mailer.ts:84:13)

  console.log
    [MAILER] Usando cuenta de prueba de Ethereal (no necesitas credenciales).

      at createTransporter (src/config/mailer.ts:23:13)

  console.log
    [MAILER] Correo de prueba enviado. Vista previa disponible en: https://ethereal.email/message/aPZnKYw8PbMuALKuaPZnLoQ.v3CUwlaYAAAAAtaENHRTNtXRVvk8BW6QnK8

      at sendVerificationEmail (src/config/mailer.ts:84:13)

  console.log
    [DB] Desconectado de MongoDB

      at disconnectDB (src/config/db.ts:21:11)

PASS tests/e2e/level-system.e2e.test.ts (8.783 s)
  Sistema de Niveles
    ‚àö deber√≠a registrar el historial cuando un personaje sube de nivel (3662 ms)
    ‚àö deber√≠a mantener un historial completo de subidas de nivel (3064 ms)

  console.log
    [DB] Conectado a MongoDB

      at connectDB (src/config/db.ts:12:11)

  console.log
    [API] Modo test: no se inicia conexi√≥n autom√°tica a MongoDB ni servidor HTTP.

      at Object.<anonymous> (src/app.ts:169:11)

  console.log
    [MAILER] Usando cuenta de prueba de Ethereal (no necesitas credenciales).

      at createTransporter (src/config/mailer.ts:23:13)

  console.log
    [MAILER] Correo de prueba enviado. Vista previa disponible en: https://ethereal.email/message/aPZnMYw8PbMuALMOaPZnNFPQQmY65XmZAAAAAYdqB0nvVFjZ7OsNDVzBv6c

      at sendVerificationEmail (src/config/mailer.ts:84:13)

  console.log
    [DB] Desconectado de MongoDB

      at disconnectDB (src/config/db.ts:21:11)

PASS tests/e2e/auth.e2e.test.ts (5.12 s)
  Auth E2E
    ‚àö should register, login and get health (3542 ms)

  console.log
    [DB] Conectado a MongoDB

      at connectDB (src/config/db.ts:12:11)

  console.log
    [API] Modo test: no se inicia conexi√≥n autom√°tica a MongoDB ni servidor HTTP.

      at Object.<anonymous> (src/app.ts:169:11)

  console.log
    [MAILER] Usando cuenta de prueba de Ethereal (no necesitas credenciales).

      at createTransporter (src/config/mailer.ts:23:13)

  console.log
    [MAILER] Correo de prueba enviado. Vista previa disponible en: https://ethereal.email/message/aPZnNow8PbMuALN-aPZnOFPQQmY65XmiAAAAAQjxE1ar10ueFY7MLctkxJc

      at sendVerificationEmail (src/config/mailer.ts:84:13)

  console.log
    [DB] Desconectado de MongoDB

      at disconnectDB (src/config/db.ts:21:11)

PASS tests/e2e/onboarding.e2e.test.ts
  Onboarding E2E
    ‚àö register -> verify should deliver pioneer package (3313 ms)

Test Suites: 1 failed, 3 passed, 4 total
Tests:       5 failed, 11 passed, 16 total
Snapshots:   0 total
Time:        32.558 s, estimated 33 s
Ran all test suites.
